<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Troubleshoot VMIS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap e Fontes para o visual -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        /* Variáveis e Estilos base (Dark Mode com Amarelo) */
        :root {
            --yellow-500: #ffc107; 
            --yellow-700: #bf9105; 
            --bg-body: #0a0a0a;
            --bg-dark-1: #111; 
            --bg-dark-2: #222; 
            --text-light: #e7e1e1; 
            --text-secondary: #e7e1e1;
            --border-color: #333;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-secondary);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        .navbar {
            background-color: var(--bg-dark-1) !important;
            border-bottom: 1px solid var(--yellow-700);
        }

        .form-control, .form-select {
            background-color: var(--bg-dark-2) !important;
            color: var(--text-secondary) !important;
            border-color: var(--border-color) !important;
        }
        .form-control:focus, .form-select:focus {
            box-shadow: 0 0 0 0.25rem rgba(255, 193, 7, .4);
            border-color: var(--yellow-500) !important;
        }

        .form-control::placeholder { 
            color: #888 !important; 
            opacity: 1; 
        }

        label, .form-label {
            color: var(--text-secondary) !important;
        }

        .card {
            background-color: var(--bg-dark-1);
            border: 1px solid var(--border-color);
        }

        .table {
            --bs-table-bg: var(--bg-dark-1);
            --bs-table-striped-bg: var(--bg-dark-2);
            --bs-table-color: var(--text-light);
            --bs-table-border-color: var(--border-color);
        }

        .table thead th {
            color: var(--yellow-500);
            border-bottom: 1px solid var(--yellow-700);
        }

        .table tbody td {
            color: var(--text-light);
        }

        .table-hover tbody tr:hover {
            background-color: var(--bg-dark-2) !important;
            color: var(--text-light) !important;
        }
        
        .table-responsive-scroll {
            max-height: 400px;
            overflow-y: auto;
            display: block;
        }

        .table-responsive-scroll thead, 
        .table-responsive-scroll thead th {
            position: sticky;
            top: 0;
            background-color: var(--bg-dark-1);
            z-index: 2;
        }

        .modal-content {
            background-color: var(--bg-dark-1);
            border: 1px solid var(--yellow-700);
        }

        .modal-header, .modal-footer {
            border-bottom: 1px solid var(--border-color);
            border-top: 1px solid var(--border-color);
        }

        .text-light {
            color: var(--yellow-500) !important;
        }
        
        .btn-warning {
            background-color: var(--yellow-700);
            color: black;
            border-color: var(--yellow-700);
        }
        .btn-warning:hover {
            background-color: var(--yellow-500);
            border-color: var(--yellow-500);
            color: black;
        }
        .btn-outline-warning {
            color: var(--yellow-500);
            border-color: var(--yellow-700);
        }
        .btn-outline-warning:hover {
            background-color: var(--yellow-700);
            color: black;
        }
        
        .btn-close-white {
            filter: invert(1); /* Torna o X branco */
        }
    </style>
</head>
<body>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-tools" style="color: var(--yellow-500);"></i> Dashboard Troubleshoot
            </a>
            <div class="d-flex align-items-center">
                <!-- O valor 'user' foi substituído por uma variável JS para execução direta -->
                <span class="navbar-text me-3" id="navbar-user">
                    Olá, [Nome de Utilizador]
                </span>
                <a href="#" class="btn btn-outline-warning">Sair</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- O bloco de Flash Messages foi removido para evitar o erro de sintaxe. -->

        <!-- CARD CADASTRO -->
        <div class="card mb-4">
            <div class="card-header text-light">
                <h5><i class="bi bi-plus-circle-fill"></i> Cadastrar Novo Erro</h5>
            </div>
            <div class="card-body">
                <form id="cadastroForm">
                    <input type="hidden" name="action" value="cadastrar">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="erro" class="form-label">Descrição do Erro</label>
                            <input type="text" class="form-control" name="erro" id="cadastro-erro" required>
                        </div>
                        <div class="col-md-6 mb-3">
                             <label for="servico" class="form-label">Serviço Afetado</label>
                            <select class="form-select" name="servico" id="cadastro-servico" required>
                                <option value="" selected disabled>-- Selecione um serviço --</option>
                                <!-- Opções preenchidas via JS -->
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="solucao" class="form-label">Solução</label>
                        <textarea class="form-control" name="solucao" id="cadastro-solucao" rows="3" required></textarea>
                    </div>
                   <button type="submit" class="btn btn-warning">
                        <i class="bi bi-plus-circle" style="margin-right: 4px;"></i> Cadastrar
                    </button>
                    <button type="reset" class="btn btn-secondary">Limpar</button>
                </form>
            </div>
        </div>

        <!-- CARD TABELA -->
        <div class="card">
           <div class="card-header">
                <div class="d-flex flex-wrap justify-content-between align-items-center">
                    <h5 class="text-light mb-2 mb-md-0"><i class="bi bi-list-ul"></i> Erros Cadastrados (<span id="registroCount">0</span>)</h5>
                    <div class="d-flex flex-grow-1 mx-md-3 mb-2 mb-md-0" style="max-width: 400px;">
                        <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="Pesquisar Erro, Serviço ou Solução...">
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                        <!-- Links de exportação alterados para '#' pois a rota 'url_for' não funciona em HTML puro -->
                        <a href="#" class="btn btn-sm btn-outline-light"><i class="bi bi-file-earmark-spreadsheet"></i> Exportar CSV</a>
                        <a href="#" class="btn btn-sm btn-outline-light"><i class="bi bi-file-earmark-pdf"></i> Exportar PDF</a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive-scroll">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th style="width: 5%;">ID</th>
                                <th style="width: 25%;">Erro</th>
                                <th style="width: 15%;">Serviço</th>
                                <th style="width: 35%;">Solução</th>
                                <!-- NOVA COLUNA -->
                                <th style="width: 10%;">Cadastrado Por</th> 
                                <th style="width: 10%;">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="errosTableBody">
                            <!-- Linhas preenchidas via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE EDIÇÃO -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-light">Editar Erro</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="editForm">
                    <input type="hidden" name="action" value="alterar">
                    <input type="hidden" name="id" id="edit-id">
                    <div class="modal-body">
                         <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit-erro" class="form-label">Descrição do Erro</label>
                                <input type="text" class="form-control" name="erro" id="edit-erro" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                 <label for="edit-servico" class="form-label">Serviço Afetado</label>
                                <select class="form-select" name="servico" id="edit-servico" required>
                                    <!-- Opções preenchidas via JS -->
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="edit-solucao" class="form-label">Solução</label>
                            <textarea class="form-control" name="solucao" id="edit-solucao" rows="5" required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-warning">Salvar Alterações</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE EXCLUSÃO (Aparece apenas se MOCK_IS_ADMIN for true) -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-light">Confirmar Exclusão</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja apagar este erro? Esta ação não pode ser desfeita.</p>
                </div>
                <div class="modal-footer">
                     <form id="deleteForm">
                         <input type="hidden" name="action" value="apagar">
                         <input type="hidden" name="id" id="delete-id">
                         <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                         <button type="submit" class="btn btn-danger">Apagar</button>
                     </form>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- MOCK DATA (Simulando o Backend) ---
        const MOCK_SERVICES = ["VMIS", "SAP", "Infraestrutura", "Rede", "Segurança", "Financeiro"];
        const MOCK_USER_EMAIL = "joao.silva@empresa.com";
        const MOCK_IS_ADMIN = true; // Simulação de privilégio
        let MOCK_ERROS = [
            { id: 101, erro: "Falha na conexão com o banco de dados.", servico: "VMIS", solucao: "Verificar credenciais e reiniciar o serviço DB.", user_email: "ana.costa@empresa.com" },
            { id: 102, erro: "Tela branca após login no SAP.", servico: "SAP", solucao: "Limpar cache do navegador e reabrir o aplicativo.", user_email: "joao.silva@empresa.com" },
            { id: 103, erro: "Impressora de rede não encontrada.", servico: "Rede", solucao: "Pingar o IP. Se falhar, verificar o cabeamento físico.", user_email: "pedro.souza@empresa.com" },
            { id: 104, erro: "Erro 500 ao salvar formulário.", servico: "Infraestrutura", solucao: "Consultar logs do servidor para rastrear o erro interno.", user_email: "ana.costa@empresa.com" },
            { id: 105, erro: "Alerta de certificado expirado.", servico: "Segurança", solucao: "Renovar o certificado SSL no servidor web.", user_email: "joao.silva@empresa.com" }
        ];

        // Função para extrair nome.sobrenome do email
        function formatUserEmail(email) {
            return email.split('@')[0];
        }
        
        // Função para preencher a tabela com os dados
        function renderTable(errosToRender) {
            const tableBody = document.getElementById('errosTableBody');
            tableBody.innerHTML = '';
            
            if (errosToRender.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center">Nenhum erro cadastrado ou encontrado.</td></tr>`;
                document.getElementById('registroCount').textContent = 0;
                return;
            }

            errosToRender.forEach(erro => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-id', erro.id);
                
                // Estrutura da linha com a nova coluna 'Cadastrado Por' (índice 4)
                tr.innerHTML = `
                    <td>${erro.id}</td>
                    <td>${erro.erro}</td>
                    <td>${erro.servico}</td>
                    <td style="white-space: pre-wrap;">${erro.solucao}</td>
                    <td>${formatUserEmail(erro.user_email)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-warning editBtn" 
                                data-bs-toggle="modal" 
                                data-bs-target="#editModal"
                                data-id="${erro.id}"
                                data-erro="${erro.erro}"
                                data-servico="${erro.servico}"
                                data-solucao="${erro.solucao}">
                            <i class="bi bi-pencil-square"></i>
                        </button>
                        ${MOCK_IS_ADMIN ? `
                        <button class="btn btn-sm btn-outline-danger deleteBtn" 
                                data-bs-toggle="modal" 
                                data-bs-target="#deleteModal"
                                data-id="${erro.id}">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                        ` : ''}
                    </td>
                `;
                tableBody.appendChild(tr);
            });
            
            document.getElementById('registroCount').textContent = errosToRender.length;
        }

        // Função para preencher os dropdowns (formulários)
        function populateServiceSelects() {
            const selectIds = ['cadastro-servico', 'edit-servico'];
            
            selectIds.forEach(selectId => {
                const selectElement = document.getElementById(selectId);
                if (!selectElement) return;

                // Limpar opções existentes (exceto o placeholder)
                if (selectId === 'edit-servico') selectElement.innerHTML = ''; 

                MOCK_SERVICES.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service;
                    option.textContent = service;
                    selectElement.appendChild(option);
                });
            });
        }


        document.addEventListener('DOMContentLoaded', function () {
            // 1. Inicialização de dados e UI
            document.getElementById('navbar-user').textContent = `Olá, ${formatUserEmail(MOCK_USER_EMAIL)}`;
            populateServiceSelects();
            renderTable(MOCK_ERROS);


            // 2. Lógica de Filtro
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('keyup', function() {
                const filter = searchInput.value.toLowerCase().trim();
                
                const filteredErros = MOCK_ERROS.filter(erro => {
                    const searchString = `${erro.erro} ${erro.servico} ${erro.solucao} ${formatUserEmail(erro.user_email)}`.toLowerCase();
                    return searchString.includes(filter);
                });
                
                renderTable(filteredErros);
            });

            // 3. Lógica do Modal de Edição (população)
            const editModal = document.getElementById('editModal');
            editModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const id = button.getAttribute('data-id');
                const erro = button.getAttribute('data-erro');
                const servico = button.getAttribute('data-servico');
                const solucao = button.getAttribute('data-solucao');

                editModal.querySelector('#edit-id').value = id;
                editModal.querySelector('#edit-erro').value = erro;
                editModal.querySelector('#edit-servico').value = servico;
                editModal.querySelector('#edit-solucao').value = solucao;
                editModal.querySelector('#edit-servico').value = servico; // Garante que o serviço correto está selecionado
            });

            // 4. Lógica do Modal de Deleção (população)
            const deleteModal = document.getElementById('deleteModal');
            deleteModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const id = button.getAttribute('data-id');
                deleteModal.querySelector('#delete-id').value = id;
            });
            
            // 5. Lógica de Simulação de Cadastro/Edição/Exclusão
            
            // Simulação do Form de Cadastro
            document.getElementById('cadastroForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const newId = Math.max(...MOCK_ERROS.map(e => e.id), 0) + 1;
                const newErro = {
                    id: newId,
                    erro: document.getElementById('cadastro-erro').value,
                    servico: document.getElementById('cadastro-servico').value,
                    solucao: document.getElementById('cadastro-solucao').value,
                    user_email: MOCK_USER_EMAIL // Atribui ao usuário logado
                };
                MOCK_ERROS.push(newErro);
                renderTable(MOCK_ERROS);
                e.target.reset();
                alert('Erro cadastrado com sucesso! (Simulação)');
            });

            // Simulação do Form de Edição
            document.getElementById('editForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const id = parseInt(document.getElementById('edit-id').value);
                const erroIndex = MOCK_ERROS.findIndex(e => e.id === id);
                
                if (erroIndex !== -1) {
                    MOCK_ERROS[erroIndex].erro = document.getElementById('edit-erro').value;
                    MOCK_ERROS[erroIndex].servico = document.getElementById('edit-servico').value;
                    MOCK_ERROS[erroIndex].solucao = document.getElementById('edit-solucao').value;
                    renderTable(MOCK_ERROS);
                    bootstrap.Modal.getInstance(editModal).hide();
                    alert(`Registro ${id} alterado com sucesso! (Simulação)`);
                }
            });

            // Simulação do Form de Exclusão
            document.getElementById('deleteForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const id = parseInt(document.getElementById('delete-id').value);
                const initialLength = MOCK_ERROS.length;
                MOCK_ERROS = MOCK_ERROS.filter(e => e.id !== id);
                
                if (MOCK_ERROS.length < initialLength) {
                    renderTable(MOCK_ERROS);
                    bootstrap.Modal.getInstance(deleteModal).hide();
                    alert(`Registro ${id} apagado com sucesso! (Simulação)`);
                }
            });
        });
    </script>
    </body>
</html>
