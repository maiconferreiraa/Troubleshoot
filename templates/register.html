{% extends "base.html" %}

{% block title %}
Cadastro
{% endblock %}

{% block content %}
<div class="login-container">
    
    <div class="login-header">
         <!-- Certifique-se de ter uma imagem 'logo.png' em static/images/ -->
         <img src="{{ url_for('static', filename='images/logo.png') }}" class="logo" alt="Logo">
        <h4>Crie sua Conta</h4> <p class="small" style="color: var(--text-secondary);">Cadastre-se para acessar o Dashboard.</p>
    </div>
    
    <!-- Exibe mensagens flash, se houver -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <!-- Mensagem de erro local (se aplicável, embora o flask use o flash global aqui) -->
    {% if error_message %}
        <div class="alert alert-danger" role="alert">
            {{ error_message }}
        </div>
    {% endif %}

    <form method="POST" action="{{ url_for('register') }}" id="registerForm" novalidate>
        <div class="mb-3">
            <label for="email" class="form-label">E-mail</label>
            <input type="email" class="form-control" id="email" name="email" placeholder="seu.email@vmis.com.br" required>
        </div>
        <div class="mb-3">
            <label for="password" class="form-label">Senha</label>
            <input type="password" class="form-control" id="password" name="password" required minlength="6">
        </div>
        <div class="mb-3">
            <label for="confirm_password" class="form-label">Confirme a Senha</label>
            <input type="password" class="form-control" id="confirm_password" name="confirm_password" required minlength="6">
            <div class="invalid-feedback" id="passwordMatchError">
                As senhas não conferem.
            </div>
        </div>
        
        <div class="d-grid gap-2 mt-4">
            <button type="submit" class="btn btn-login">
                CADASTRAR
            </button>
        </div>
    </form>

    <p class="text-center mt-3 small" style="color: var(--text-secondary);">
        Já tem uma conta? <a href="{{ url_for('login') }}" style="color: var(--yellow-500);">Faça Login</a>
    </p>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Inicialização de alerts
        var alertList = document.querySelectorAll('.alert');
        alertList.forEach(function (alert) {
            new bootstrap.Alert(alert);
            setTimeout(function() {
                var bsAlert = bootstrap.Alert.getInstance(alert);
                if (bsAlert) {
                    bsAlert.close();
                }
            }, 5000); // Fecha alertas após 5 segundos
        });

        // VALIDAÇÃO DE CONFIRMAÇÃO DE SENHA (JavaScript)
        const form = document.getElementById('registerForm');
        const password = document.getElementById('password');
        const confirmPassword = document.getElementById('confirm_password');
        const errorDiv = document.getElementById('passwordMatchError');

        const validatePasswords = () => {
            const isMatch = password.value === confirmPassword.value && password.value.length >= 6;

            if (confirmPassword.value.length === 0) {
                 confirmPassword.classList.remove('is-valid', 'is-invalid');
                 errorDiv.style.display = 'none';
                 return false; // Não permite submissão se o campo estiver vazio
            } else if (!isMatch) {
                confirmPassword.classList.add('is-invalid');
                confirmPassword.classList.remove('is-valid');
                errorDiv.style.display = 'block';
                return false;
            } else {
                confirmPassword.classList.add('is-valid');
                confirmPassword.classList.remove('is-invalid');
                errorDiv.style.display = 'none';
                return true;
            }
        };

        // Adiciona a validação ao submeter o formulário
        form.addEventListener('submit', function(event) {
            if (!validatePasswords() || password.value.length < 6) {
                event.preventDefault(); 
                event.stopPropagation();
                // Força o display do erro se for o caso
                if(password.value !== confirmPassword.value) {
                     confirmPassword.classList.add('is-invalid');
                     errorDiv.style.display = 'block';
                }
            }
            form.classList.add('was-validated');
        }, false);

        // Valida ao digitar nos campos de senha
        password.addEventListener('keyup', validatePasswords);
        confirmPassword.addEventListener('keyup', validatePasswords);
    });
</script>
{% endblock %}
